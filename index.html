<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WebOS ‚Äî Demo</title>
<style>
  :root{
    --bg-1:#071229; --bg-2:#0b2240; --card:#0f1a2a; --muted:#9fb0c8; --accent:#4da3ff;
    --win:#031224; --glass:rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, sans-serif;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#eaf6ff}
  .app{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
  .screen{width:980px;height:620px;border-radius:16px;box-shadow:0 30px 80px rgba(0,0,0,.6);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));position:relative;overflow:hidden}
  @media (max-width:520px){ .screen{width:360px;height:720px;border-radius:24px} }

  /* views */
  .view{position:absolute;inset:0;padding:28px;display:none}
  .view.active{display:block}

  /* registration/login */
  .card{max-width:480px;margin:40px auto;background:var(--glass);padding:20px;border-radius:12px}
  label{display:block;margin-bottom:6px;color:var(--muted);font-size:13px}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;margin-bottom:10px}
  button{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#6ecbff);color:#012;cursor:pointer}

  /* lock screen */
  .lock-center{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%}
  .clock{font-weight:700;font-size:68px;letter-spacing:1px}
  .subclock{font-size:14px;color:var(--muted)}

  /* desktop/home */
  .desktop{display:flex;flex-direction:column;height:100%}
  .topbar{display:flex;align-items:center;justify-content:space-between}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-top:18px}
  .appcard{background:var(--glass);padding:14px;border-radius:12px;text-align:center;cursor:pointer;user-select:none;position:relative}
  .ico{width:60px;height:60px;border-radius:14px;background:linear-gradient(135deg,#fff2,#0002);display:inline-flex;align-items:center;justify-content:center;font-weight:700}

  /* windows */
  .window{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:640px;height:420px;background:var(--win);border-radius:12px;padding:10px;box-shadow:0 30px 80px rgba(0,0,0,0.7);display:none;color:#cfe9ff}
  .window.show{display:block}
  @media (max-width:520px){ .window{width:320px;height:520px} }

  /* window header with close button */
  .win-header{display:flex;justify-content:flex-end;align-items:center;height:42px;padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .close-btn{
    width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;cursor:pointer;
    transition: transform 0.22s ease, background-color 0.28s ease, box-shadow 0.22s ease;
    color:#ffdfe0;font-weight:700;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  }
  /* hover animation -> go red and scale (only visible on desktop via JS/CSS class) */
  .close-btn:hover{ background:#ff4d4d; transform:scale(1.06) rotate(8deg); box-shadow:0 8px 20px rgba(255,77,77,0.2) }

  /* hide close button on small screens via CSS fallback */
  @media (max-width:768px){ .close-btn{display:none !important} }

  /* notes, admin etc */
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center}
  .note{background:rgba(255,255,255,0.02);padding:10px;margin-bottom:8px;border-radius:8px}

  /* phone nav (visible on small screens) */
  .phone-nav{position:absolute;left:0;right:0;bottom:0;height:64px;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:space-around;padding:8px}
  .phone-nav .btn{width:56px;height:40px;border-radius:8px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;cursor:pointer}
  @media (max-width:768px){ .phone-nav{display:flex} .screen{height:calc(100vh - 0px);} }

  /* desktop taskbar (only on desktop) */
  .taskbar{position:absolute;left:0;right:0;bottom:0;height:56px;background:rgba(0,0,0,0.25);display:flex;align-items:center;padding:6px;gap:10px}
  .taskbar .task{width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;cursor:pointer}
  @media (max-width:768px){ .taskbar{display:none} }

  /* small helpers */
  .settings-menu{width:180px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
  .settings-panel{flex:1;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
</style>
</head>
<body>
<div class="app">
  <div class="screen" id="screen">

    <!-- Registration -->
    <div class="view active" id="view-register">
      <div class="card">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <label>–ò–º—è</label><input id="reg-name" type="text" placeholder="–ò–º—è">
        <label>–ü–∞—Ä–æ–ª—å</label><input id="reg-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <label>–ê–≤–∞—Ç–∞—Ä (—Ü–≤–µ—Ç)</label>
        <select id="reg-avatar">
          <option value="#4da3ff">–°–∏–Ω–∏–π</option>
          <option value="#ff9f43">–û—Ä–∞–Ω–∂–µ–≤—ã–π</option>
          <option value="#9b59b6">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
          <option value="#2ecc71">–ó–µ–ª—ë–Ω—ã–π</option>
          <option value="#e74c3c">–ö—Ä–∞—Å–Ω—ã–π</option>
        </select>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="muted">–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" id="to-login">–í–æ–π—Ç–∏</a></div>
          <button id="do-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>
      </div>
    </div>

    <!-- Login -->
    <div class="view" id="view-login">
      <div class="card">
        <h2>–í—Ö–æ–¥</h2>
        <label>–ò–º—è</label><input id="login-name" type="text" placeholder="–ò–º—è">
        <label>–ü–∞—Ä–æ–ª—å</label><input id="login-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="muted">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="to-reg">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></div>
          <button id="do-login">–í–æ–π—Ç–∏</button>
        </div>
      </div>
    </div>

    <!-- Lock -->
    <div class="view" id="view-lock">
      <div class="lock-center">
        <div style="text-align:center">
          <div class="clock" id="lock-time">--:--</div>
          <div class="subclock" id="lock-date">--</div>
          <div style="margin-top:12px" class="muted">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: <strong id="device-type">–ü–ö</strong></div>
        </div>

        <div style="margin-top:22px;width:320px;max-width:90%">
          <button id="unlock-btn" class="">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
          <div style="height:10px"></div>
          <button id="enter-pass" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit">–í–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å</button>
        </div>
      </div>
    </div>

    <!-- Password modal -->
    <div class="window" id="win-pass">
      <div class="win-header"><div style="flex:1"></div><!-- close not needed for pass modal --></div>
      <h3>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</h3>
      <input id="prompt-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
      <div style="margin-top:10px" class="row"><button id="ok-pass">–û–ö</button><button id="cancel-pass">–û—Ç–º–µ–Ω–∞</button></div>
    </div>

    <!-- Home -->
    <div class="view" id="view-home">
      <div class="desktop">
        <div class="topbar">
          <div>
            <div class="clock" id="home-time">--:--</div>
            <div class="subclock" id="home-date">--</div>
          </div>
          <div class="row" style="align-items:center">
            <div id="user-avatar" style="width:48px;height:48px;border-radius:50%;background:#4da3ff"></div>
            <div style="margin-left:10px">
              <div id="user-name">–ì–æ—Å—Ç—å</div>
              <div class="muted" id="user-status">–û–Ω–ª–∞–π–Ω</div>
            </div>
          </div>
        </div>

        <div class="grid" id="home-grid" style="margin-top:18px">
          <div class="appcard" data-app="calculator"><div class="ico">C</div><div>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div></div>
          <div class="appcard" data-app="settings"><div class="ico">S</div><div>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div></div>
          <div class="appcard" data-app="store"><div class="ico">üõí</div><div>–ú–∞–≥–∞–∑–∏–Ω</div></div>
          <div class="appcard" data-app="admin"><div class="ico">A</div><div>–ê–¥–º–∏–Ω</div></div>
        </div>
      </div>
    </div>

    <!-- Calculator Window -->
    <div class="window" id="win-calc">
      <div class="win-header"><div style="flex:1"></div><div class="close-btn" data-win="win-calc" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</div></div>
      <h3>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h3>
      <input id="calc-display" readonly style="padding:10px;border-radius:8px;border:0;background:#052034;color:#dff;margin-bottom:8px">
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
        <button class="btn-calc">7</button><button class="btn-calc">8</button><button class="btn-calc">9</button><button class="btn-calc">/</button>
        <button class="btn-calc">4</button><button class="btn-calc">5</button><button class="btn-calc">6</button><button class="btn-calc">*</button>
        <button class="btn-calc">1</button><button class="btn-calc">2</button><button class="btn-calc">3</button><button class="btn-calc">-</button>
        <button class="btn-calc">0</button><button class="btn-calc">.</button><button id="calc-eq" class="btn-calc">=</button><button class="btn-calc">+</button>
      </div>
    </div>

    <!-- Settings Window -->
    <div class="window" id="win-settings">
      <div class="win-header"><div style="flex:1"></div><div class="close-btn" data-win="win-settings" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</div></div>
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <div style="display:flex;gap:12px;height:330px">
        <div class="settings-menu">
          <div class="muted" style="margin-bottom:8px">–†–∞–∑–¥–µ–ª—ã</div>
          <div><button class="menu-btn" data-section="account">–ê–∫–∫–∞—É–Ω—Ç</button></div>
          <div><button class="menu-btn" data-section="updates">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</button></div>
          <div><button class="menu-btn" data-section="walls">–û–±–æ–∏</button></div>
          <div><button class="menu-btn" data-section="system">–°–∏—Å—Ç–µ–º–Ω–∞—è –ø–∞–ø–∫–∞</button></div>
          <div style="margin-top:8px"><button class="menu-btn" data-section="password">–ü–∞—Ä–æ–ª—å</button></div>
        </div>
        <div class="settings-panel" id="settings-content">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª</div>
      </div>
    </div>

    <!-- Store Window -->
    <div class="window" id="win-store">
      <div class="win-header"><div style="flex:1"></div><div class="close-btn" data-win="win-store" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</div></div>
      <h3>–ú–∞–≥–∞–∑–∏–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π</h3>
      <div style="display:flex;gap:12px;height:330px">
        <div style="flex:1;display:flex;flex-direction:column">
          <div class="muted">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
          <div style="flex:1;overflow:auto;margin-top:8px" id="store-list"></div>
        </div>
        <div style="width:220px;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px">
          <div class="muted">–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ</div>
          <div id="installed-list" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- Admin Window -->
    <div class="window" id="win-admin">
      <div class="win-header"><div style="flex:1"></div><div class="close-btn" data-win="win-admin" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</div></div>
      <h3>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h3>
      <div style="display:flex;gap:12px;height:330px">
        <div style="flex:1;overflow:auto" id="admin-accounts"></div>
        <div style="width:260px;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px">
          <div class="muted">–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞</div>
          <input id="admin-pass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)" type="password">
          <div style="height:8px"></div>
          <button id="save-admin-pass">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Notes Window -->
    <div class="window" id="win-notes">
      <div class="win-header"><div style="flex:1"></div><div class="close-btn" data-win="win-notes" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</div></div>
      <h3>–ó–∞–º–µ—Ç–∫–∏</h3>
      <div style="display:flex;gap:10px;height:320px">
        <div style="width:220px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px">
          <div class="muted">–°–ø–∏—Å–æ–∫</div>
          <div id="notes-list" style="margin-top:8px;max-height:240px;overflow:auto"></div>
          <button id="new-note" style="margin-top:8px">–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞</button>
        </div>
        <div style="flex:1;display:flex;flex-direction:column">
          <input id="note-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" style="padding:8px;border-radius:8px;border:0;background:#021224;color:#cff;margin-bottom:8px">
          <textarea id="note-body" style="flex:1;padding:8px;border-radius:8px;border:0;background:#021224;color:#cff"></textarea>
          <div style="display:flex;justify-content:flex-end;margin-top:8px"><button id="save-note">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
        </div>
      </div>
    </div>

    <!-- Phone nav -->
    <div class="phone-nav" id="phone-nav">
      <div class="btn" id="phone-back">‚óÄ</div>
      <div class="btn" id="phone-home">‚óØ</div>
      <div class="btn" id="phone-recent">‚ñ¶</div>
    </div>

    <!-- Desktop taskbar -->
    <div class="taskbar" id="taskbar"></div>

  </div>
</div>

<script>
/* ============================
   Utilities & Storage helpers
   ============================ */
const utils = {
  str2ab: s => new TextEncoder().encode(s),
  ab2hex: buf => Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''),
  hex2ab: hex => new Uint8Array(hex.match(/.{1,2}/g).map(h=>parseInt(h,16))).buffer,
  randHex: (n)=>{ const b=new Uint8Array(n); crypto.getRandomValues(b); return Array.from(b).map(x=>x.toString(16).padStart(2,'0')).join('') }
};

// crypto hash (SHA-256) with fallback to simple djb2 if unavailable
async function sha256Hex(str){
  if(window.crypto && crypto.subtle && typeof crypto.subtle.digest === 'function'){
    const buf = await crypto.subtle.digest('SHA-256', utils.str2ab(str));
    return utils.ab2hex(buf);
  } else { // fallback (NOT cryptographically secure)
    let h = 5381; for(let i=0;i<str.length;i++){ h = ((h<<5)+h) + str.charCodeAt(i); h = h & 0xffffffff }
    return String(h>>>0);
  }
}

/* Database wrapper */
const DB = {
  get users(){ return JSON.parse(localStorage.getItem('webos_users_v3')||'[]') },
  set users(v){ localStorage.setItem('webos_users_v3', JSON.stringify(v)) },
  get session(){ return JSON.parse(localStorage.getItem('webos_session_v3')||'null') },
  set session(v){ localStorage.setItem('webos_session_v3', JSON.stringify(v)) },
  get adminHash(){ return localStorage.getItem('webos_admin_hash_v3') || null },
  set adminHash(v){ localStorage.setItem('webos_admin_hash_v3', v) },
  get installed(){ return JSON.parse(localStorage.getItem('webos_installed_v3')||'[]') },
  set installed(a){ localStorage.setItem('webos_installed_v3', JSON.stringify(a)) }
};

/* init default admin password (hashed 'admin') */
(async ()=>{ if(!DB.adminHash){ DB.adminHash = await sha256Hex('admin') } })();

/* helpers */
const $ = id => document.getElementById(id);
const isMobile = ()=> window.innerWidth <= 768;
function showView(id){ document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); $(id).classList.add('active') }
function showWindow(id){ document.querySelectorAll('.window').forEach(w=>w.classList.remove('show')); $(id).classList.add('show'); updateTaskbar() }
function closeWindow(id){ $(id).classList.remove('show'); updateTaskbar() }

/* device text */
$('device-type').textContent = isMobile() ? '–¢–µ–ª–µ—Ñ–æ–Ω' : '–ü–ö';
window.addEventListener('resize', ()=> $('device-type').textContent = isMobile() ? '–¢–µ–ª–µ—Ñ–æ–Ω' : '–ü–ö');

/* ===============
   Time management
   =============== */
function updateTime(){
  const d = new Date(); const hh = String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0');
  $('lock-time').textContent = `${hh}:${mm}`; $('home-time').textContent = `${hh}:${mm}`; $('lock-date').textContent = d.toLocaleString(); $('home-date').textContent = d.toLocaleDateString();
}
updateTime(); setInterval(updateTime,1000);

/* ======================
   User / Registration
   ====================== */
function findUserByName(name){ return DB.users.find(u=>u.name===name) }
function currentUser(){ const s = DB.session; if(!s) return null; return DB.users.find(u=>u.id===s.id) }

async function createUser(name, pass, color){
  const salt = utils.randHex(8);
  const passHash = await sha256Hex(pass + salt);
  const id = Date.now();
  const users = DB.users;
  users.push({id,name,passHash,salt,color,bannedUntil:null,failedAttempts:0,lockUntil:null});
  DB.users = users;
  // init empty notes per user
  localStorage.setItem('notes_'+id, JSON.stringify([]));
  DB.session = {id};
}

$('do-register').addEventListener('click', async ()=>{
  const name = $('reg-name').value.trim(); const pass = $('reg-pass').value; const color = $('reg-avatar').value;
  if(!name || !pass){ alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –ø–∞—Ä–æ–ª—å'); return; }
  if(findUserByName(name)){ alert('–ò–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ'); return; }
  await createUser(name,pass,color); renderUser(); showView('view-lock');
});

/* login */
$('to-reg').addEventListener('click', ()=> showView('view-register'));
$('to-login').addEventListener('click', ()=> showView('view-login'));

$('do-login').addEventListener('click', async ()=>{
  const name = $('login-name').value.trim(); const pass = $('login-pass').value;
  const u = findUserByName(name);
  if(!u){ alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'); return; }
  const now = Date.now();
  if(u.lockUntil && now < u.lockUntil){ alert('–ê–∫–∫–∞—É–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'); return; }
  const tryHash = await sha256Hex(pass + u.salt);
  if(tryHash !== u.passHash){
    u.failedAttempts = (u.failedAttempts||0) + 1;
    if(u.failedAttempts >= 5){ u.lockUntil = Date.now() + 5*60*1000; u.failedAttempts = 0; alert('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ 5 –º–∏–Ω—É—Ç'); }
    else alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
    DB.users = DB.users.map(x=>x.id===u.id?u:x);
    return;
  }
  u.failedAttempts = 0; u.lockUntil = null; DB.users = DB.users.map(x=>x.id===u.id?u:x);
  DB.session = {id: u.id}; renderUser(); showView('view-lock');
});

/* logout, delete user */
function logout(){ DB.session = null; showView('view-login') }
function deleteCurrentUser(){ const u = currentUser(); if(!u) return; if(!confirm('–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) return; DB.users = DB.users.filter(x=>x.id!==u.id); localStorage.removeItem('notes_'+u.id); DB.session=null; showView('view-register'); alert('–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª—ë–Ω') }

/* ==================
   Lock / Unlock
   ================== */
$('unlock-btn').addEventListener('click', ()=>{
  const u = currentUser(); if(!u){ showView('view-register'); return; }
  // default: unlock to home (unless user wants password)
  showView('view-home'); renderUser();
});
$('enter-pass').addEventListener('click', ()=>{ showWindow('win-pass'); });
$('cancel-pass').addEventListener('click', ()=>{ closeWindow('win-pass'); });
$('ok-pass').addEventListener('click', async ()=>{
  const p = $('prompt-pass').value; const u = currentUser(); if(!u){ alert('–ù–µ—Ç —Å–µ—Å—Å–∏–∏'); closeWindow('win-pass'); showView('view-register'); return; }
  const ph = await sha256Hex(p + u.salt);
  if(ph === u.passHash){ closeWindow('win-pass'); showView('view-home'); renderUser(); }
  else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
});

/* ===========================
   Windows management & close
   =========================== */
function openWindow(id){
  showWindow(id);
  // create task icon in taskbar (desktop only)
  updateTaskbar();
}
function closeAppByBtn(el){
  const winId = el.dataset.win;
  closeWindow(winId);
}
document.querySelectorAll('.close-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{ const id = btn.dataset.win; closeWindow(id); });
});

/* Taskbar: show icons for open windows (desktop) */
function updateTaskbar(){
  const tb = $('taskbar'); tb.innerHTML = '';
  if(isMobile()) return;
  document.querySelectorAll('.window.show').forEach(win=>{
    const id = win.id;
    const t = document.createElement('div'); t.className='task'; t.title = id; t.textContent = id.replace('win-','').slice(0,2).toUpperCase();
    t.addEventListener('click', ()=>{ // focus toggle
      if(win.classList.contains('show')){ win.classList.remove('show'); } else { win.classList.add('show'); }
    });
    tb.appendChild(t);
  });
}

/* Close animation only on desktop: handled by CSS hover transition (close-btn) and by JS visibility rule */
function applyCloseVisibility(){
  // show close buttons only on desktop (redundant with CSS, but ensure)
  const visible = !isMobile();
  document.querySelectorAll('.close-btn').forEach(b=>{ b.style.display = visible ? 'flex' : 'none'; });
}
applyCloseVisibility();
window.addEventListener('resize', ()=>{ applyCloseVisibility(); updateTaskbar(); });

/* =====================
   Calculator logic
   ===================== */
let calcVal = '';
document.querySelectorAll('.btn-calc').forEach(b=> b.addEventListener('click', ()=>{ calcVal += b.textContent; $('calc-display').value = calcVal; }));
$('calc-eq').addEventListener('click', ()=>{ try{ const res = eval(calcVal); $('calc-display').value = String(res); calcVal = String(res); }catch(e){ alert('–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è') } });

/* =========================
   Settings menu handling
   ========================= */
document.querySelectorAll('.menu-btn').forEach(b=> b.addEventListener('click', ()=> {
  const sec = b.dataset.section; const cont = $('settings-content');
  if(sec === 'account'){
    const u = currentUser();
    cont.innerHTML = `<div><strong>–ò–º—è:</strong> ${u?u.name:'-'}</div>
      <div style="margin-top:8px"><strong>–ê–≤–∞—Ç–∞—Ä:</strong><div style='width:56px;height:56px;border-radius:50%;background:${u?u.color:'#666'};margin-top:6px'></div></div>
      <div style='margin-top:12px'><button id='btn-logout'>–í—ã–π—Ç–∏</button> <button id='btn-del'>–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button></div>`;
    cont.querySelector('#btn-logout').addEventListener('click', ()=>{ logout(); showView('view-login'); });
    cont.querySelector('#btn-del').addEventListener('click', ()=>{ deleteCurrentUser(); });
  }
  if(sec === 'walls'){
    cont.innerHTML = `<div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ–∏ (5)</div><div style='display:flex;gap:8px;margin-top:8px' id='wall-list'></div>`;
    const list = ['linear-gradient(180deg,#071229,#0b2240)','linear-gradient(180deg,#0b2d12,#052)','linear-gradient(180deg,#35123a,#6b2b7f)','linear-gradient(180deg,#2a2a72,#0f9)','linear-gradient(180deg,#3a0b0b,#2a0b2b)'];
    const wrap = cont.querySelector('#wall-list');
    list.forEach(s=>{ const el = document.createElement('div'); el.style.width='80px'; el.style.height='120px'; el.style.borderRadius='8px'; el.style.background=s; el.style.cursor='pointer'; el.addEventListener('click', ()=>{ document.body.style.background = s; alert('–û–±–æ–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã'); }); wrap.appendChild(el); });
  }
  if(sec === 'system'){
    cont.innerHTML = `<div class="muted">–°–∏—Å—Ç–µ–º–Ω–∞—è –ø–∞–ø–∫–∞</div><div style='margin-top:8px'><div style='display:flex;align-items:center;gap:10px'><div style='width:46px;height:46px;border-radius:8px;background:#0b2a44;display:flex;align-items:center;justify-content:center'>üìÅ</div><div>–°–∏—Å—Ç–µ–º–Ω–∞—è –ø–∞–ø–∫–∞</div></div><div style='margin-top:12px'><button id='del-folder'>–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É</button></div></div>`;
    cont.querySelector('#del-folder').addEventListener('click', ()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—É—é –ø–∞–ø–∫—É? –≠—Ç–æ –≤—ã–≤–µ–¥–µ—Ç —ç–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –≤—Ö–æ–¥–∞.')){ DB.session = null; showView('view-register'); }});
  }
  if(sec === 'updates'){
    const last = localStorage.getItem('webos_last_update_v3') || '2025-01-01';
    const now = '2025-08-01';
    cont.innerHTML = `<div><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> ${last}</div><div style='margin-top:8px'><strong>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:</strong> ${now}</div>`;
  }
  if(sec === 'password'){
    // allow setting/removing screen password (we will store hashed password in user's passHash by re-hashing with salt)
    const u = currentUser();
    if(!u){ cont.innerHTML = '<div>–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–æ–ª—å</div>'; return; }
    cont.innerHTML = `<div><label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label><input id='set-pass' type='password'></div><div style='margin-top:8px'><button id='save-pass'>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button> <button id='remove-pass'>–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä–æ–ª—å</button></div><div class="muted" style="margin-top:8px">–ü–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ (SHA-256 + —Å–æ–ª—å)</div>`;
    cont.querySelector('#save-pass').addEventListener('click', async ()=>{
      const p = cont.querySelector('#set-pass').value; if(!p){ alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'); return; }
      u.salt = utils.randHex(8); u.passHash = await sha256Hex(p + u.salt); DB.users = DB.users.map(x=>x.id===u.id?u:x); alert('–ü–∞—Ä–æ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'); });
    cont.querySelector('#remove-pass').addEventListener('click', ()=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä–æ–ª—å —ç–∫—Ä–∞–Ω–∞?')) return; // cannot truly remove without password, but we reset to random hash
      const tmp = Math.random().toString(36); u.salt = utils.randHex(8); sha256Hex(tmp+u.salt).then(h=>{ u.passHash=h; DB.users = DB.users.map(x=>x.id===u.id?u:x); alert('–ü–∞—Ä–æ–ª—å —É–¥–∞–ª—ë–Ω (—Å–±—Ä–æ—à–µ–Ω)'); }); });
  }
}));

/* ============================
   Store (install notes app)
   ============================ */
const APPS = [{id:'notes', title:'–ó–∞–º–µ—Ç–∫–∏', desc:'–ü—Ä–æ—Å—Ç—ã–µ –∑–∞–º–µ—Ç–∫–∏, –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –∞–∫–∫–∞—É–Ω—Ç—É'}];
function renderStore(){ const out = $('store-list'); out.innerHTML = ''; APPS.forEach(a=>{ const div = document.createElement('div'); div.style.padding='8px'; div.style.borderRadius='8px'; div.style.marginBottom='8px'; div.style.background='rgba(255,255,255,0.02)'; div.innerHTML = `<div style='font-weight:700'>${a.title}</div><div class='muted' style='font-size:13px'>${a.desc}</div><div style='margin-top:8px'><button data-install='${a.id}'>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button></div>`; out.appendChild(div);}); renderInstalled(); }
document.addEventListener('click', e=>{ if(e.target.dataset.install){ const id = e.target.dataset.install; const arr = DB.installed; if(!arr.includes(id)) arr.push(id); DB.installed = arr; renderStore(); alert('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ '+id); } });
function renderInstalled(){ const out = $('installed-list'); out.innerHTML = ''; DB.installed.forEach(id=>{ const b = document.createElement('div'); b.style.marginBottom='6px'; const btn = document.createElement('button'); btn.textContent = id; btn.addEventListener('click', ()=>{ if(id==='notes'){ openWindow('win-notes'); loadNotes(); } }); b.appendChild(btn); out.appendChild(b); }); }

/* ===========================
   Notes app (per-user)
   =========================== */
function loadNotes(){
  const u = currentUser(); if(!u){ alert('–í–æ–π–¥–∏—Ç–µ'); return; }
  const key = 'notes_'+u.id; const arr = JSON.parse(localStorage.getItem(key)||'[]'); const list = $('notes-list'); list.innerHTML='';
  arr.forEach((n, idx)=>{ const el = document.createElement('div'); el.className='note'; el.textContent = n.title || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'; el.addEventListener('click', ()=>{ $('note-title').value = n.title; $('note-body').value = n.body; $('save-note').dataset.idx = idx; }); list.appendChild(el); });
}
$('new-note').addEventListener('click', ()=>{ $('note-title').value=''; $('note-body').value=''; delete $('save-note').dataset.idx; });
$('save-note').addEventListener('click', ()=>{ const u = currentUser(); if(!u){ alert('–í–æ–π–¥–∏—Ç–µ'); return; } const key = 'notes_'+u.id; const arr = JSON.parse(localStorage.getItem(key)||'[]'); const idx = $('save-note').dataset.idx; const obj = {title:$('note-title').value, body:$('note-body').value}; if(idx===undefined) arr.push(obj); else arr[idx] = obj; localStorage.setItem(key, JSON.stringify(arr)); loadNotes(); alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); });

/* =========================
   Admin panel (ban users)
   ========================= */
function renderAdmin(){
  const cont = $('admin-accounts'); cont.innerHTML='';
  DB.users.forEach(u=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderRadius='8px'; div.style.marginBottom='8px'; div.style.background='rgba(255,255,255,0.02)';
    div.innerHTML = `<div style='display:flex;align-items:center;gap:10px'><div style='width:48px;height:48px;border-radius:50%;background:${u.color}'></div><div style='flex:1'>${u.name}<div class='muted' style='font-size:12px'>id:${u.id}</div></div><div><button data-ban='${u.id}'>–ë–∞–Ω</button></div></div>`;
    cont.appendChild(div);
  });
}
document.addEventListener('click', e=>{ if(e.target.dataset.ban){ const id = Number(e.target.dataset.ban); const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –±–∞–Ω–∞'); const minutes = prompt('–ù–∞ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç (0 = –Ω–∞–≤—Å–µ–≥–¥–∞)'); if(minutes===null) return; const m = Number(minutes); const until = m>0 ? Date.now() + m*60*1000 : 9999999999999; DB.users = DB.users.map(u => u.id===id ? ({...u, bannedUntil:until, banReason:reason}) : u); renderAdmin(); alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω'); } });

/* change admin password (hash) */
$('save-admin-pass').addEventListener('click', async ()=>{
  const p = $('admin-pass').value; if(!p){ alert('–ü—É—Å—Ç–æ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π'); return; }
  DB.adminHash = await sha256Hex(p); $('admin-pass').value=''; alert('–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω—ë–Ω');
});

/* admin protection on opening */
document.querySelector('[data-app="admin"]').addEventListener('click', async ()=>{
  const attempt = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞'); if(attempt===null) return;
  const h = await sha256Hex(attempt);
  if(h !== DB.adminHash){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'); return; }
  renderAdmin(); openWindow('win-admin');
});

/* open windows (app icons) */
document.querySelectorAll('.appcard').forEach(el=> el.addEventListener('click', ()=> {
  const app = el.dataset.app;
  if(app==='calculator') openWindow('win-calc');
  if(app==='settings') openWindow('win-settings');
  if(app==='store'){ renderStore(); openWindow('win-store'); }
  if(app==='admin'){ /* handled above*/ }
}));

/* when opening windows ensure close button animates (CSS) and update taskbar */
document.querySelectorAll('.window').forEach(w=>{
  // Add event: doubleclick outside to close handled later
});

/* generic close buttons (already wired by dataset) */
document.querySelectorAll('.close-btn').forEach(btn=> btn.addEventListener('click', ()=> {
  const id = btn.dataset.win; closeWindow(id);
}));

/* ===========================
   Phone navigation handlers
   =========================== */
$('phone-home').addEventListener('click', ()=> { showView('view-home'); });
$('phone-back').addEventListener('click', ()=> { /* simple: go to lock */ showView('view-lock'); });
$('phone-recent').addEventListener('click', ()=> { alert('–ù–µ–¥–∞–≤–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–¥–µ–º–æ)'); });

/* ===========================
   Initial render & session restore
   =========================== */
function renderUser(){
  const u = currentUser();
  if(!u){ $('user-name').textContent = '–ì–æ—Å—Ç—å'; $('user-avatar').style.background = '#666'; return; }
  $('user-name').textContent = u.name; $('user-avatar').style.background = u.color;
  // update installed list and taskbar
  renderInstalled(); updateTaskbar();
}
(function init(){
  renderUser();
  if(DB.session) showView('view-lock'); else showView('view-register');
})();

/* small UX: dblclick closes windows */
document.addEventListener('dblclick', ()=> document.querySelectorAll('.window').forEach(w=> w.classList.remove('show')));

/* show/hide close buttons depending on device initial */
function refreshCloseButtons(){
  document.querySelectorAll('.close-btn').forEach(b => { b.style.display = isMobile() ? 'none' : 'flex'; });
}
refreshCloseButtons(); window.addEventListener('resize', ()=> { refreshCloseButtons(); updateTaskbar(); });

/* small note: ensure when deleting system folder we clear session */
window.deleteSystemFolder = function(){ if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—É—é –ø–∞–ø–∫—É?')){ DB.session = null; showView('view-register'); } };

</script>
</body>
</html>
